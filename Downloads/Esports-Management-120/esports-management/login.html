<!DOCTYPE html>
<html>
<head>
  <title>Login - Esports Management</title>
  <link rel="stylesheet" href="css/login.css">
</head>
<body>
  <div class="container">
    <h2>Login</h2>

    <p id="errorMessage" style="color: red; font-weight: bold;"></p>

    <form id="loginForm">
      <label>Email:</label>
      <input type="email" id="email" required>

      <label>Password:</label>
      <input type="password" id="password" required>

      <button type="submit">Login</button>
      <a href="signup.html">Don't have an account? Sign up here</a>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  
  <script>
    // üîπ Same Firebase config as Signup page
    const firebaseConfig = {
      apiKey: "AIzaSyDUFqfDlyZF_aA18Dc7ytirEja6E2rFCgQ",
      authDomain: "esports-62899.firebaseapp.com",
      databaseURL: "https://esports-62899-default-rtdb.firebaseio.com",
      projectId: "esports-62899",
      storageBucket: "esports-62899.appspot.com",  // ‚úÖ fixed
      messagingSenderId: "561025327999",
      appId: "1:561025327999:web:76a25a1f580903263ff04a",
      measurementId: "G-ZRLL1WY4D7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('loginForm');
      const errorEl = document.getElementById('errorMessage');

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorEl.textContent = '';

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        try {
          // 1Ô∏è‚É£ Firebase Auth login
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const idToken = await userCredential.user.getIdToken();

          // 2Ô∏è‚É£ Get role from backend
          const res = await fetch("http://localhost:3000/api/auth/get-role", {
            method: "GET",
            headers: { "Authorization": `Bearer ${idToken}` }
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to fetch role");

          const role = data.role;

          if (!role) {
            errorEl.textContent = "User role not found. Make sure you signed up correctly.";
            return;
          }

          // 3Ô∏è‚É£ Redirect based on role
          if (role === 'admin') window.location.href = 'admin_dashboard.html';
          else if (role === 'team_manager') window.location.href = 'manager_dashboard.html';
          else if (role === 'player') window.location.href = 'player_dashboard.html';
          else window.location.href = 'spectator_dashboard.html';

        } catch (err) {
          console.error(err);
          errorEl.textContent = err.message;
        }
      });
    });
  </script>
</body>
</html>
